<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sorikama Hub</title>
    <meta name="description" content="Sorikama Hub API Gateway Dashboard">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif']
                    },
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; }
        .theme-transition { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .glass {
            backdrop-filter: blur(16px) saturate(180%);
            background-color: rgba(255, 255, 255, 0.75);
            border: 1px solid rgba(209, 213, 219, 0.3);
        }
        .dark .glass {
            background-color: rgba(17, 25, 40, 0.75);
            border: 1px solid rgba(255, 255, 255, 0.125);
        }
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .dark .card-hover:hover {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
        }
        .status-online { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="theme-transition bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white min-h-screen">

    <!-- Header -->
    <header class="glass sticky top-0 z-50 theme-transition border-b border-gray-200 dark:border-gray-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                
                <!-- Logo & Title -->
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-r from-primary-500 to-primary-600 rounded-xl flex items-center justify-center">
                        <i class="fas fa-cube text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900 dark:text-white">Sorikama Hub</h1>
                        <p class="text-xs text-gray-500 dark:text-gray-400 font-medium">API Gateway Dashboard</p>
                    </div>
                </div>
                
                <!-- User Info & Controls -->
                <div class="flex items-center space-x-4">
                    
                    <!-- Theme Switcher -->
                    <div class="flex items-center bg-gray-100 dark:bg-gray-800 rounded-lg p-1">
                        <button id="theme-light" class="p-2 rounded-md transition-colors" title="Light mode">
                            <i class="fas fa-sun text-sm"></i>
                        </button>
                        <button id="theme-dark" class="p-2 rounded-md transition-colors" title="Dark mode">
                            <i class="fas fa-moon text-sm"></i>
                        </button>
                        <button id="theme-system" class="p-2 rounded-md transition-colors" title="System mode">
                            <i class="fas fa-desktop text-sm"></i>
                        </button>
                    </div>
                    
                    <!-- Status -->
                    <div class="flex items-center space-x-2">
                        <div class="w-2 h-2 bg-green-500 rounded-full status-online"></div>
                        <span class="text-sm text-green-600 dark:text-green-400 font-medium hidden sm:block">Online</span>
                    </div>
                    
                    <!-- User Menu -->
                    <div class="flex items-center space-x-3">
                        <div class="text-right hidden sm:block">
                            <p class="text-sm font-medium text-gray-900 dark:text-white" id="username">Admin</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">Administrator</p>
                        </div>
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                            <i class="fas fa-sign-out-alt mr-1"></i>
                            <span class="hidden sm:inline">Logout</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Welcome Section -->
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Welcome back!</h2>
            <p class="text-gray-600 dark:text-gray-400">Manage your API Gateway and monitor system performance.</p>
        </div>
        
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg border border-gray-200 dark:border-gray-700 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Services Status</p>
                        <p class="text-2xl font-bold text-green-600 dark:text-green-400" id="servicesStatus">Loading...</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400" id="servicesDetail">Checking...</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 dark:bg-green-900 rounded-xl flex items-center justify-center">
                        <i class="fas fa-heartbeat text-green-600 dark:text-green-400 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg border border-gray-200 dark:border-gray-700 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-400">SSO Sessions</p>
                        <p class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="ssoSessions">0</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Active sessions</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900 rounded-xl flex items-center justify-center">
                        <i class="fas fa-users text-blue-600 dark:text-blue-400 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg border border-gray-200 dark:border-gray-700 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Requests 24h</p>
                        <p class="text-2xl font-bold text-purple-600 dark:text-purple-400" id="requests24h">0</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400" id="successRate">0% success</p>
                    </div>
                    <div class="w-12 h-12 bg-purple-100 dark:bg-purple-900 rounded-xl flex items-center justify-center">
                        <i class="fas fa-chart-line text-purple-600 dark:text-purple-400 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg border border-gray-200 dark:border-gray-700 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-400">System Uptime</p>
                        <p class="text-2xl font-bold text-orange-600 dark:text-orange-400" id="uptime">0s</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Since last restart</p>
                    </div>
                    <div class="w-12 h-12 bg-orange-100 dark:bg-orange-900 rounded-xl flex items-center justify-center">
                        <i class="fas fa-clock text-orange-600 dark:text-orange-400 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- API Key Section -->
        <div class="bg-gradient-to-r from-yellow-50 to-orange-50 dark:from-yellow-900/20 dark:to-orange-900/20 rounded-2xl p-6 mb-8 border border-yellow-200 dark:border-yellow-800">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <h3 class="text-lg font-semibold text-yellow-800 dark:text-yellow-200 mb-2">
                        <i class="fas fa-key mr-2"></i>Temporary API Key
                    </h3>
                    <div class="bg-black/10 dark:bg-black/30 rounded-lg p-4 mb-4">
                        <code class="text-sm font-mono text-yellow-900 dark:text-yellow-100 break-all" id="apiKey">Loading...</code>
                    </div>
                    <p class="text-sm text-yellow-700 dark:text-yellow-300">
                        <i class="fas fa-exclamation-triangle mr-1"></i>
                        This key is valid only during your session and will be deleted on logout.
                    </p>
                </div>
                <button onclick="copyApiKey()" class="ml-4 bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                    <i class="fas fa-copy mr-1"></i>Copy
                </button>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-8">
            
            <a href="/api-docs" class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg border border-gray-200 dark:border-gray-700 card-hover group">
                <div class="text-center">
                    <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform">
                        <i class="fas fa-book text-blue-600 dark:text-blue-400 text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">API Documentation</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Swagger UI with all endpoints</p>
                </div>
            </a>
            
            <a href="/api-keys/manager" class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg border border-gray-200 dark:border-gray-700 card-hover group">
                <div class="text-center">
                    <div class="w-16 h-16 bg-yellow-100 dark:bg-yellow-900 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform">
                        <i class="fas fa-key text-yellow-600 dark:text-yellow-400 text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">API Keys</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Manage API keys</p>
                </div>
            </a>
            
            <a href="/performance/metrics" class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg border border-gray-200 dark:border-gray-700 card-hover group">
                <div class="text-center">
                    <div class="w-16 h-16 bg-purple-100 dark:bg-purple-900 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform">
                        <i class="fas fa-tachometer-alt text-purple-600 dark:text-purple-400 text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Metrics</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Real-time performance</p>
                </div>
            </a>
            
            <a href="/system/health" class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg border border-gray-200 dark:border-gray-700 card-hover group">
                <div class="text-center">
                    <div class="w-16 h-16 bg-green-100 dark:bg-green-900 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform">
                        <i class="fas fa-heartbeat text-green-600 dark:text-green-400 text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">System Health</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">System status</p>
                </div>
            </a>
            
            <a href="/logs/viewer" class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg border border-gray-200 dark:border-gray-700 card-hover group">
                <div class="text-center">
                    <div class="w-16 h-16 bg-indigo-100 dark:bg-indigo-900 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform">
                        <i class="fas fa-file-alt text-indigo-600 dark:text-indigo-400 text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Logs Viewer</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">System logs</p>
                </div>
            </a>
            
            <a href="/services/manager" class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg border border-gray-200 dark:border-gray-700 card-hover group">
                <div class="text-center">
                    <div class="w-16 h-16 bg-cyan-100 dark:bg-cyan-900 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform">
                        <i class="fas fa-network-wired text-cyan-600 dark:text-cyan-400 text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Services</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Service management</p>
                </div>
            </a>
            
            <a href="/admin/stats" class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg border border-gray-200 dark:border-gray-700 card-hover group">
                <div class="text-center">
                    <div class="w-16 h-16 bg-orange-100 dark:bg-orange-900 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform">
                        <i class="fas fa-cogs text-orange-600 dark:text-orange-400 text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Admin Stats</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Administrator statistics</p>
                </div>
            </a>
            
            <a href="/dependencies" class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg border border-gray-200 dark:border-gray-700 card-hover group">
                <div class="text-center">
                    <div class="w-16 h-16 bg-pink-100 dark:bg-pink-900 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform">
                        <i class="fas fa-cube text-pink-600 dark:text-pink-400 text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Dependencies</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Installed packages</p>
                </div>
            </a>
            
        </div>
        
        <!-- System Information -->
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg border border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                <i class="fas fa-info-circle mr-2"></i>System Information
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                <div class="flex justify-between">
                    <span class="text-gray-600 dark:text-gray-400">Environment:</span>
                    <span class="font-medium text-gray-900 dark:text-white" id="environment">development</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600 dark:text-gray-400">Port:</span>
                    <span class="font-medium text-gray-900 dark:text-white" id="port">7000</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600 dark:text-gray-400">Base URL:</span>
                    <span class="font-medium text-gray-900 dark:text-white" id="baseUrl">http://localhost:7000/api/v1</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600 dark:text-gray-400">Session ID:</span>
                    <span class="font-medium text-gray-900 dark:text-white font-mono" id="sessionId">Loading...</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600 dark:text-gray-400">Session Expires:</span>
                    <span class="font-medium text-gray-900 dark:text-white" id="sessionExpires">Loading...</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600 dark:text-gray-400">Time Remaining:</span>
                    <span class="font-medium text-gray-900 dark:text-white" id="timeRemaining">Loading...</span>
                </div>
            </div>
        </div>
        
    </main>

    <script>
        // Theme Management
        class ThemeManager {
            constructor() {
                this.theme = localStorage.getItem('theme') || 'system';
                this.init();
            }
            
            init() {
                this.applyTheme();
                this.setupEventListeners();
                this.updateButtons();
            }
            
            applyTheme() {
                const root = document.documentElement;
                
                if (this.theme === 'system') {
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    root.classList.toggle('dark', prefersDark);
                } else {
                    root.classList.toggle('dark', this.theme === 'dark');
                }
            }
            
            setTheme(newTheme) {
                this.theme = newTheme;
                localStorage.setItem('theme', newTheme);
                this.applyTheme();
                this.updateButtons();
            }
            
            updateButtons() {
                const buttons = {
                    light: document.getElementById('theme-light'),
                    dark: document.getElementById('theme-dark'),
                    system: document.getElementById('theme-system')
                };
                
                Object.keys(buttons).forEach(key => {
                    const button = buttons[key];
                    if (button) {
                        button.classList.toggle('bg-primary-100', key === this.theme);
                        button.classList.toggle('text-primary-600', key === this.theme);
                        button.classList.toggle('dark:bg-primary-900', key === this.theme);
                        button.classList.toggle('dark:text-primary-400', key === this.theme);
                    }
                });
            }
            
            setupEventListeners() {
                document.getElementById('theme-light')?.addEventListener('click', () => this.setTheme('light'));
                document.getElementById('theme-dark')?.addEventListener('click', () => this.setTheme('dark'));
                document.getElementById('theme-system')?.addEventListener('click', () => this.setTheme('system'));
                
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                    if (this.theme === 'system') {
                        this.applyTheme();
                    }
                });
            }
        }

        // Dashboard functionality
        class DashboardManager {
            constructor() {
                this.init();
            }
            
            init() {
                this.loadMonitoringData();
                this.startRealTimeUpdates();
            }
            
            async loadMonitoringData() {
                try {
                    const response = await fetch('/monitoring/stats');
                    const result = await response.json();
                    
                    if (result.success) {
                        this.updateStats(result.data);
                    }
                } catch (error) {
                    console.error('Erreur chargement monitoring:', error);
                }
            }
            
            updateStats(stats) {
                // Services status
                const healthPercentage = Math.round((stats.services.active / stats.services.total) * 100);
                document.getElementById('servicesStatus').textContent = healthPercentage + '%';
                document.getElementById('servicesDetail').textContent = `${stats.services.active}/${stats.services.total} active`;
                
                // SSO Sessions
                document.getElementById('ssoSessions').textContent = stats.sso.activeSessions;
                
                // Requests 24h
                document.getElementById('requests24h').textContent = stats.requests24h.total.toLocaleString();
                document.getElementById('successRate').textContent = stats.requests24h.successRate + '% success';
            }
            
            startRealTimeUpdates() {
                // Mettre Ã  jour toutes les 30 secondes
                setInterval(() => {
                    this.loadMonitoringData();
                }, 30000);
            }
        }
        
        function copyApiKey() {
            const apiKey = document.getElementById('apiKey').textContent;
            navigator.clipboard.writeText(apiKey).then(() => {
                showToast('API Key copied to clipboard!', 'success');
            }).catch(() => {
                showToast('Failed to copy API Key', 'error');
            });
        }

        async function logout() {
            try {
                const response = await fetch('/portal/logout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                if (result.success) {
                    window.location.href = result.redirectUrl;
                }
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = '/portal/login';
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white font-medium z-50 transform translate-x-full transition-transform duration-300 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        function formatUptime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else if (minutes > 0) {
                return `${minutes}m ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }

        function updateCountdown() {
            // This will be populated by the server-side data
            const sessionData = window.sessionData || {};
            
            if (sessionData.expiresAt) {
                const now = Date.now();
                const remaining = sessionData.expiresAt - now;
                
                if (remaining <= 0) {
                    document.getElementById('timeRemaining').textContent = 'Expired';
                    setTimeout(() => {
                        window.location.href = '/portal/login';
                    }, 2000);
                    return;
                }
                
                const hours = Math.floor(remaining / (1000 * 60 * 60));
                const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
                
                document.getElementById('timeRemaining').textContent = `${hours}h ${minutes}m ${seconds}s`;
            }
        }

        // Initialize everything
        document.addEventListener('DOMContentLoaded', function() {
            new ThemeManager();
            new DashboardManager();
            
            // Update uptime
            setInterval(() => {
                const uptimeElement = document.getElementById('uptime');
                if (window.serverUptime !== undefined) {
                    window.serverUptime += 1;
                    uptimeElement.textContent = formatUptime(window.serverUptime);
                }
            }, 1000);
            
            // Update countdown
            setInterval(updateCountdown, 1000);
            updateCountdown();
        });
    </script>

</body>
</html>