openapi: '3.0.0'
info:
  title: API Gateway Sorikama
  version: '1.0.0'
  description: Documentation de l'API Gateway pour le projet Sorikama.
servers:
  - url: http://localhost:7000/api/v1
    description: Serveur de développement
tags:
  - name: Authentification
    description: Endpoints pour l'inscription, la connexion et la récupération de compte.
  - name: Gestion de Compte
    description: Endpoints pour la gestion du profil utilisateur une fois connecté.

# --- Définition de la Sécurité ---
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: 'Entrez le token JWT obtenu lors de la connexion. Ne pas inclure le préfixe "Bearer ".'
  schemas:
    Error:
      type: object
      properties:
        status:
          type: string
          example: 'fail'
        message:
          type: string
      required:
        - status
        - message
    
    # --- Schémas pour l'Authentification ---
    SignupRequest:
      type: object
      required: [firstName, lastName, email, password]
      properties:
        firstName: { type: string, example: "Marie" }
        lastName: { type: string, example: "Curie" }
        email: { type: string, format: email, example: "marie.curie@example.com" }
        password: { type: string, format: password, example: "Password@123" }
    VerifyAccountRequest:
      type: object
      required: [verificationToken, code]
      properties:
        verificationToken: { type: string, description: "Token temporaire reçu lors de l'appel à /register." }
        code: { type: string, description: "Le code à 6 chiffres.", example: "123456" }
    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email: { type: string, format: email, example: "marie.curie@example.com" }
        password: { type: string, format: password, example: "Password@123" }
    AuthTokens:
      type: object
      properties:
        accessToken: { type: string }
        refreshToken: { type: string }
    RefreshTokenRequest:
      type: object
      required: [refreshToken]
      properties:
        refreshToken: { type: string }
    ForgotPasswordRequest:
      type: object
      required: [email]
      properties:
        email: { type: string, format: email, example: "marie.curie@example.com" }
    ResetPasswordRequest:
      type: object
      required: [password]
      properties:
        password: { type: string, format: password, example: "NewStrongPassword@123" }
    
    # --- Schémas pour la Gestion de Compte ---
    UpdateMeRequest:
      type: object
      properties:
        firstName: { type: string, example: "Maria" }
        lastName: { type: string, example: "Skłodowska" }
    UpdatePasswordRequest:
      type: object
      required: [currentPassword, newPassword]
      properties:
        currentPassword: { type: string, format: password, example: "Password@123" }
        newPassword: { type: string, format: password, example: "NewStrongerPassword@123" }
    User:
      type: object
      properties:
        _id: { type: string, example: "a1b2c3d4-e5f6-..." }
        firstName: { type: string, example: "Marie" }
        lastName: { type: string, example: "Curie" }
        email: { type: string, example: "marie.curie@example.com" }
        roles: { type: array, items: { type: string, example: "user" } }

# --- Définition des Routes ---
paths:
  # --- Routes d'Authentification ---
  /auth/register:
    post:
      tags: [Authentification]
      summary: Étape 1 - Demander la création d'un compte
      requestBody:
        required: true
        content:
          application/json: { schema: { $ref: '#/components/schemas/SignupRequest' } }
      responses:
        '200': { description: Email de vérification envoyé. }

  /auth/verify:
    post:
      tags: [Authentification]
      summary: Étape 2 - Vérifier le code et créer le compte
      requestBody:
        required: true
        content:
          application/json: { schema: { $ref: '#/components/schemas/VerifyAccountRequest' } }
      responses:
        '201':
          description: Compte créé.
          content:
            application/json: { schema: { $ref: '#/components/schemas/AuthTokens' } }

  /auth/login:
    post:
      tags: [Authentification]
      summary: Connexion d'un utilisateur
      requestBody:
        required: true
        content:
          application/json: { schema: { $ref: '#/components/schemas/LoginRequest' } }
      responses:
        '200':
          description: Connexion réussie.
          content:
            application/json: { schema: { $ref: '#/components/schemas/AuthTokens' } }

  /auth/refresh-token:
    post:
      tags: [Authentification]
      summary: Obtenir un nouvel access token
      requestBody:
        required: true
        content:
          application/json: { schema: { $ref: '#/components/schemas/RefreshTokenRequest' } }
      responses:
        '200':
          description: Nouveaux tokens générés.
          content:
            application/json: { schema: { $ref: '#/components/schemas/AuthTokens' } }
  
  /auth/forgot-password:
    post:
      tags: [Authentification]
      summary: Demander une réinitialisation de mot de passe (Étape 1)
      requestBody:
        required: true
        content:
          application/json: { schema: { $ref: '#/components/schemas/ForgotPasswordRequest' } }
      responses:
        '200': { description: Demande traitée. }

  /auth/reset-password/{token}:
    post:
      tags: [Authentification]
      summary: Réinitialiser le mot de passe avec un token (Étape 2)
      parameters:
        - in: path
          name: token
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json: { schema: { $ref: '#/components/schemas/ResetPasswordRequest' } }
      responses:
        '200': { description: Mot de passe réinitialisé. }

  # --- Routes de Gestion de Compte ---
  /auth/logout:
    post:
      tags: [Gestion de Compte]
      summary: Déconnexion de l'utilisateur
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json: { schema: { $ref: '#/components/schemas/RefreshTokenRequest' } }
      responses:
        '200': { description: Déconnexion réussie. }

  /auth/me:
    get:
      tags: [Gestion de Compte]
      summary: Récupérer le profil de l'utilisateur connecté
      security: [{ bearerAuth: [] }]
      responses:
        '200':
          description: Profil de l'utilisateur.
          content:
            application/json: { schema: { $ref: '#/components/schemas/User' } }

  /auth/update-me:
    patch:
      tags: [Gestion de Compte]
      summary: Mettre à jour le profil de l'utilisateur (prénom, nom)
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json: { schema: { $ref: '#/components/schemas/UpdateMeRequest' } }
      responses:
        '200':
          description: Profil mis à jour.
          content:
            application/json: { schema: { $ref: '#/components/schemas/User' } }

  /auth/update-password:
    patch:
      tags: [Gestion de Compte]
      summary: Mettre à jour le mot de passe de l'utilisateur connecté
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json: { schema: { $ref: '#/components/schemas/UpdatePasswordRequest' } }
      responses:
        '200': { description: Mot de passe mis à jour. }

  # --- Routes Système ---
  /system/health:
    get:
      tags: [Système]
      summary: Vérification de santé du système
      responses:
        '200':
          description: Système opérationnel
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      status:
                        type: string
                        example: "healthy"
                      timestamp:
                        type: string
                        format: date-time
                      gateway:
                        type: object
                        properties:
                          version:
                            type: string
                            example: "1.0.0"
                          uptime:
                            type: number
                            example: 3600
        '503':
          description: Service indisponible
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

# Sécurité globale
security:
  - bearerAuth: []