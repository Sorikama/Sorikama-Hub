openapi: '3.0.0'
info:
  title: Sorikama API Gateway - Hub Central
  version: '1.0.0'
  description: API Gateway centralis√©e pour l'√©cosyst√®me Sorikama
  contact:
    name: Support Sorikama
    url: https://sorikama.com/support
    email: support@sorikama.com
  license:
    name: MIT License
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:7000/api/v1
    description: Serveur de d√©veloppement local

tags:
  - name: Authentification
    description: Endpoints d'authentification et inscription
  - name: Gestion de Compte
    description: Gestion du profil utilisateur connect√©
  - name: Syst√®me
    description: Endpoints syst√®me, r√¥les et permissions
  - name: SSO
    description: Single Sign-On et sessions
  - name: Services Externes
    description: Endpoints pour les services externes (callbacks, profil utilisateur)
  - name: Administration
    description: Endpoints d'administration syst√®me

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Token JWT d'authentification

  schemas:
    Error:
      type: object
      properties:
        status: { type: string, example: 'fail' }
        message: { type: string }
      required: [status, message]

    SignupRequest:
      type: object
      required: [firstName, lastName, email, password]
      properties:
        firstName: { type: string, example: "Marie" }
        lastName: { type: string, example: "Curie" }
        email: { type: string, format: email, example: "marie.curie@example.com" }
        password: { type: string, format: password, example: "Password@123" }

    VerifyAccountRequest:
      type: object
      required: [verificationToken, code]
      properties:
        verificationToken: { type: string }
        code: { type: string, example: "123456" }

    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email: { type: string, format: email, example: "marie.curie@example.com" }
        password: { type: string, format: password, example: "Password@123" }

    AuthTokens:
      type: object
      properties:
        accessToken: { type: string }
        refreshToken: { type: string }

    RefreshTokenRequest:
      type: object
      required: [refreshToken]
      properties:
        refreshToken: { type: string }

    ForgotPasswordRequest:
      type: object
      required: [email]
      properties:
        email: { type: string, format: email, example: "marie.curie@example.com" }

    ResetPasswordRequest:
      type: object
      required: [password]
      properties:
        password: { type: string, format: password, example: "NewPassword@123" }

    UpdateMeRequest:
      type: object
      properties:
        firstName: { type: string, example: "Maria" }
        lastName: { type: string, example: "Sk≈Çodowska" }

    UpdatePasswordRequest:
      type: object
      required: [currentPassword, newPassword]
      properties:
        currentPassword: { type: string, format: password }
        newPassword: { type: string, format: password }

    User:
      type: object
      properties:
        _id: { type: string, example: "a1b2c3d4-e5f6-..." }
        firstName: { type: string, example: "Marie" }
        lastName: { type: string, example: "Curie" }
        email: { type: string, example: "marie.curie@example.com" }
        roles: { type: array, items: { type: string, example: "user" } }

    Role:
      type: object
      properties:
        id: { type: string }
        name: { type: string, example: "admin" }
        description: { type: string }
        permissions: { type: array, items: { type: string } }

    Permission:
      type: object
      properties:
        id: { type: string }
        action: { type: string, example: "read" }
        subject: { type: string, example: "user" }
        description: { type: string }

    Service:
      type: object
      properties:
        id: { type: string, example: "service" }
        name: { type: string, example: "Service Name" }
        description: { type: string, example: "Service description" }
        url: { type: string, example: "http://localhost:3001" }
        icon: { type: string, example: "üõçÔ∏è" }
        color: { type: string, example: "#3b82f6" }
        status: { type: string, enum: ["active", "inactive", "maintenance"], example: "active" }
        version: { type: string, example: "1.0.0" }
        endpoints: { type: array, items: { type: string } }
        responseTime: { type: number, example: 150 }
        uptime: { type: number, example: 99.9 }
        requestCount: { type: number, example: 1250 }
        errorCount: { type: number, example: 5 }
        ssoEnabled: { type: boolean, example: true }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }

    UserComplete:
      type: object
      properties:
        _id: { type: string, example: "a1b2c3d4-e5f6-..." }
        firstName: { type: string, example: "Marie" }
        lastName: { type: string, example: "Curie" }
        email: { type: string, example: "marie.curie@example.com" }
        isVerified: { type: boolean, example: true }
        isActive: { type: boolean, example: true }
        roles: { type: array, items: { type: string, example: "user" } }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }

    RefreshToken:
      type: object
      properties:
        _id: { type: string }
        userId: { type: string }
        token: { type: string }
        expiresAt: { type: string, format: date-time }
        isRevoked: { type: boolean, example: false }
        createdAt: { type: string, format: date-time }

    SSOSession:
      type: object
      properties:
        _id: { type: string }
        userId: { type: string }
        serviceId: { type: string }
        sessionToken: { type: string }
        expiresAt: { type: string, format: date-time }
        isActive: { type: boolean, example: true }
        createdAt: { type: string, format: date-time }

    ServiceRequest:
      type: object
      properties:
        _id: { type: string }
        serviceId: { type: string }
        userId: { type: string }
        method: { type: string, example: "GET" }
        endpoint: { type: string, example: "/api/products" }
        statusCode: { type: number, example: 200 }
        responseTime: { type: number, example: 150 }
        timestamp: { type: string, format: date-time }
        userAgent: { type: string }
        ipAddress: { type: string }

paths:
  # === AUTHENTIFICATION ===
  /auth/register:
    post:
      tags: [Authentification]
      summary: √âtape 1 - Demander la cr√©ation d'un compte
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignupRequest'
      responses:
        '200':
          description: Email de v√©rification envoy√©
        '400':
          description: Donn√©es invalides
        '409':
          description: Email d√©j√† utilis√©

  /auth/verify:
    post:
      tags: [Authentification]
      summary: √âtape 2 - V√©rifier le code et cr√©er le compte
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VerifyAccountRequest'
      responses:
        '201':
          description: Compte cr√©√© avec succ√®s
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthTokens'

  /auth/login:
    post:
      tags: [Authentification]
      summary: Connexion d'un utilisateur
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Connexion r√©ussie
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthTokens'

  /auth/refresh-token:
    post:
      tags: [Authentification]
      summary: Obtenir un nouvel access token
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshTokenRequest'
      responses:
        '200':
          description: Nouveaux tokens g√©n√©r√©s
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthTokens'

  /auth/forgot-password:
    post:
      tags: [Authentification]
      summary: Demander une r√©initialisation de mot de passe
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ForgotPasswordRequest'
      responses:
        '200':
          description: Email de r√©initialisation envoy√©

  /auth/reset-password/{token}:
    post:
      tags: [Authentification]
      summary: R√©initialiser le mot de passe avec un token
      security: []
      parameters:
        - in: path
          name: token
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResetPasswordRequest'
      responses:
        '200':
          description: Mot de passe r√©initialis√©

  # === GESTION DE COMPTE ===
  /auth/logout:
    post:
      tags: [Gestion de Compte]
      summary: D√©connexion de l'utilisateur
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshTokenRequest'
      responses:
        '200':
          description: D√©connexion r√©ussie

  /auth/me:
    get:
      tags: [Gestion de Compte]
      summary: R√©cup√©rer le profil de l'utilisateur connect√©
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Profil de l'utilisateur
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  /auth/update-me:
    patch:
      tags: [Gestion de Compte]
      summary: Mettre √† jour le profil utilisateur
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateMeRequest'
      responses:
        '200':
          description: Profil mis √† jour
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  /auth/update-password:
    patch:
      tags: [Gestion de Compte]
      summary: Mettre √† jour le mot de passe
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdatePasswordRequest'
      responses:
        '200':
          description: Mot de passe mis √† jour

  /account/schedule-deletion:
    post:
      tags: [Gestion de Compte]
      summary: Planifier la suppression du compte (15 jours)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, fullName]
              properties:
                email: { type: string, format: email }
                fullName: { type: string }
                reason: { type: string }
      responses:
        '200':
          description: Suppression planifi√©e
        '400':
          description: Donn√©es invalides

  /account/deletion-status:
    get:
      tags: [Gestion de Compte]
      summary: Obtenir le statut de suppression du compte
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Statut de suppression
          content:
            application/json:
              schema:
                type: object
                properties:
                  accountStatus: { type: string }
                  deletionScheduledAt: { type: string, format: date-time }
                  deletionReason: { type: string }

  /account/request-cancellation-code:
    post:
      tags: [Gestion de Compte]
      summary: Demander un code pour annuler la suppression (authentifi√©)
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Code envoy√© par email

  /account/cancel-deletion:
    post:
      tags: [Gestion de Compte]
      summary: Annuler la suppression avec le code (authentifi√©)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [code]
              properties:
                code: { type: string, example: "123456" }
      responses:
        '200':
          description: Suppression annul√©e

  /account/request-cancellation-code-public:
    post:
      tags: [Gestion de Compte]
      summary: Demander un code pour annuler la suppression (public)
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email]
              properties:
                email: { type: string, format: email }
      responses:
        '200':
          description: Code envoy√© si le compte existe

  /account/cancel-deletion-public:
    post:
      tags: [Gestion de Compte]
      summary: Annuler la suppression avec le code (public)
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, code]
              properties:
                email: { type: string, format: email }
                code: { type: string, example: "123456" }
      responses:
        '200':
          description: Suppression annul√©e

  # === SYST√àME ===
  /system/health:
    get:
      tags: [Syst√®me]
      summary: V√©rification de sant√© du syst√®me
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Syst√®me op√©rationnel
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  data:
                    type: object
                    properties:
                      status: { type: string, example: "healthy" }
                      timestamp: { type: string, format: date-time }

  /system/roles:
    get:
      tags: [Syst√®me]
      summary: Lister tous les r√¥les
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Liste des r√¥les
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Role'

  /system/permissions:
    get:
      tags: [Syst√®me]
      summary: Lister toutes les permissions
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Liste des permissions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Permission'

  /system/services:
    get:
      tags: [Syst√®me]
      summary: Lister tous les services
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Liste des services
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Service'
    post:
      tags: [Syst√®me]
      summary: Cr√©er un nouveau service
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name: { type: string }
                description: { type: string }
                url: { type: string }
                icon: { type: string }
                color: { type: string }
      responses:
        '201':
          description: Service cr√©√©

  /system/services/{serviceId}:
    get:
      tags: [Syst√®me]
      summary: D√©tails d'un service
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: serviceId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: D√©tails du service
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Service'
    put:
      tags: [Syst√®me]
      summary: Mettre √† jour un service
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: serviceId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Service'
      responses:
        '200':
          description: Service mis √† jour
    delete:
      tags: [Syst√®me]
      summary: Supprimer un service
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: serviceId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Service supprim√©

  # === ACTIVATION DE COMPTE ===
  /activation/check/{token}:
    get:
      tags: [Authentification]
      summary: V√©rifier si un token d'activation est valide
      security: []
      parameters:
        - in: path
          name: token
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Token valide
        '400':
          description: Token invalide ou expir√©

  /activation/activate/{token}:
    post:
      tags: [Authentification]
      summary: Activer le compte et d√©finir le mot de passe
      security: []
      parameters:
        - in: path
          name: token
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [password]
              properties:
                password: { type: string, format: password }
      responses:
        '200':
          description: Compte activ√©

  /activation/resend:
    post:
      tags: [Authentification]
      summary: Renvoyer un email d'activation
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email]
              properties:
                email: { type: string, format: email }
      responses:
        '200':
          description: Email renvoy√©

  # === SSO ===
  /sso/login:
    post:
      tags: [SSO]
      summary: Connexion SSO
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                service: { type: string, example: "service" }
                redirectUrl: { type: string }
      responses:
        '200':
          description: Redirection SSO

  /sso/callback:
    get:
      tags: [SSO]
      summary: Callback SSO
      security: []
      parameters:
        - in: query
          name: token
          schema:
            type: string
        - in: query
          name: service
          schema:
            type: string
      responses:
        '200':
          description: Authentification SSO r√©ussie

  /sso/auth/{serviceId}:
    get:
      tags: [SSO]
      summary: Authentifier l'utilisateur pour un service
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: serviceId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Session SSO cr√©√©e

  /sso/sessions:
    get:
      tags: [SSO]
      summary: Lister les sessions SSO actives
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Liste des sessions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/SSOSession'

  /sso/revoke/{sessionId}:
    post:
      tags: [SSO]
      summary: R√©voquer une session SSO sp√©cifique
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: sessionId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Session r√©voqu√©e

  /sso/cleanup:
    post:
      tags: [SSO]
      summary: Nettoyer les sessions expir√©es
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Sessions nettoy√©es

  /sso/refresh:
    post:
      tags: [SSO]
      summary: Rafra√Æchir une session SSO (public)
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [sessionId, serviceId]
              properties:
                sessionId: { type: string }
                serviceId: { type: string }
      responses:
        '200':
          description: Session rafra√Æchie

  /sso-sessions/my-sessions:
    get:
      tags: [SSO]
      summary: Mes sessions SSO actives
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Liste de mes sessions

  /sso-sessions/revoke/{sessionId}:
    delete:
      tags: [SSO]
      summary: R√©voquer une de mes sessions
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: sessionId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Session r√©voqu√©e

  /sso-sessions/revoke-all:
    delete:
      tags: [SSO]
      summary: R√©voquer toutes mes sessions
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Toutes les sessions r√©voqu√©es

  # === AUTORISATION SSO ===
  /authorize/services/{serviceId}:
    get:
      tags: [SSO]
      summary: Obtenir les informations d'un service
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: serviceId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Informations du service

  /authorize/authorize:
    post:
      tags: [SSO]
      summary: Autoriser l'acc√®s √† un service
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [serviceId]
              properties:
                serviceId: { type: string }
                redirectUrl: { type: string }
      responses:
        '200':
          description: Code d'autorisation g√©n√©r√©

  /authorize/exchange:
    post:
      tags: [SSO]
      summary: √âchanger un code d'autorisation contre un token
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [code, serviceId]
              properties:
                code: { type: string }
                serviceId: { type: string }
      responses:
        '200':
          description: Token SSO g√©n√©r√©

  # === ADMINISTRATION ===
  /admin/users:
    get:
      tags: [Administration]
      summary: Lister tous les utilisateurs
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Liste des utilisateurs
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/UserComplete'

  /admin/users/{userId}:
    get:
      tags: [Administration]
      summary: D√©tails d'un utilisateur
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: userId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: D√©tails de l'utilisateur
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserComplete'
    delete:
      tags: [Administration]
      summary: Supprimer un utilisateur
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: userId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Utilisateur supprim√©

  /admin/sessions:
    get:
      tags: [Administration]
      summary: Lister toutes les sessions SSO
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Liste des sessions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/SSOSession'

  /admin/analytics:
    get:
      tags: [Administration]
      summary: Statistiques d'utilisation
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Statistiques
          content:
            application/json:
              schema:
                type: object
                properties:
                  totalUsers: { type: number }
                  activeUsers: { type: number }
                  totalRequests: { type: number }
                  totalServices: { type: number }
                  uptime: { type: number }

  # === SERVICE USER (pour les services externes) ===
  /service-user/profile:
    get:
      tags: [Services Externes]
      summary: Obtenir le profil utilisateur (pour services externes)
      security: []
      parameters:
        - in: header
          name: X-Service-Token
          required: true
          schema:
            type: string
        - in: header
          name: X-User-Id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Profil utilisateur
    patch:
      tags: [Services Externes]
      summary: Mettre √† jour le profil utilisateur (pour services externes)
      security: []
      parameters:
        - in: header
          name: X-Service-Token
          required: true
          schema:
            type: string
        - in: header
          name: X-User-Id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                firstName: { type: string }
                lastName: { type: string }
      responses:
        '200':
          description: Profil mis √† jour

  /service-user/password:
    put:
      tags: [Services Externes]
      summary: Changer le mot de passe (pour services externes)
      security: []
      parameters:
        - in: header
          name: X-Service-Token
          required: true
          schema:
            type: string
        - in: header
          name: X-User-Id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [currentPassword, newPassword]
              properties:
                currentPassword: { type: string }
                newPassword: { type: string }
      responses:
        '200':
          description: Mot de passe chang√©

  # === SERVICE CALLBACK (pour les services externes) ===
  /service-callback/logout:
    post:
      tags: [Services Externes]
      summary: Notifier une d√©connexion (pour services externes)
      security: []
      parameters:
        - in: header
          name: X-Service-Token
          required: true
          schema:
            type: string
        - in: header
          name: X-User-Id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                reason: { type: string }
      responses:
        '200':
          description: D√©connexion enregistr√©e

  /service-callback/session-activity:
    post:
      tags: [Services Externes]
      summary: Notifier une activit√© de session (pour services externes)
      security: []
      parameters:
        - in: header
          name: X-Service-Token
          required: true
          schema:
            type: string
        - in: header
          name: X-User-Id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Activit√© enregistr√©e

  /service-callback/verify-authorization:
    get:
      tags: [Services Externes]
      summary: V√©rifier l'autorisation d'un utilisateur (pour services externes)
      security: []
      parameters:
        - in: header
          name: X-Service-Token
          required: true
          schema:
            type: string
        - in: header
          name: X-User-Id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Autorisation v√©rifi√©e

  # === PROXY DYNAMIQUE ===
  # Note: Le proxy dynamique fonctionne avec le format /{serviceSlug}/*
  # Les services sont configur√©s dynamiquement dans la base de donn√©es
  # Exemple: /mon-service/api/users redirige vers le backend du service "mon-service"

security:
  - bearerAuth: []