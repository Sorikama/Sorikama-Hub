openapi: '3.0.0'
info:
  title: Sorikama API Gateway - Hub Central
  version: '1.0.0'
  description: API Gateway centralis√©e pour l'√©cosyst√®me Sorikama
  contact:
    name: Support Sorikama
    url: https://sorikama.com/support
    email: support@sorikama.com
  license:
    name: MIT License
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:7000/api/v1
    description: Serveur de d√©veloppement local

tags:
  - name: Authentification
    description: Endpoints d'authentification et inscription
  - name: Gestion de Compte
    description: Gestion du profil utilisateur connect√©
  - name: API Keys
    description: Gestion des cl√©s API pour int√©grations
  - name: Syst√®me
    description: Endpoints syst√®me, r√¥les et permissions
  - name: SSO
    description: Single Sign-On et sessions
  - name: Proxy
    description: Routage vers les microservices
  - name: Administration
    description: Endpoints d'administration syst√®me

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API Key d'authentification
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Token JWT d'authentification

  schemas:
    Error:
      type: object
      properties:
        status: { type: string, example: 'fail' }
        message: { type: string }
      required: [status, message]

    SignupRequest:
      type: object
      required: [firstName, lastName, email, password]
      properties:
        firstName: { type: string, example: "Marie" }
        lastName: { type: string, example: "Curie" }
        email: { type: string, format: email, example: "marie.curie@example.com" }
        password: { type: string, format: password, example: "Password@123" }

    VerifyAccountRequest:
      type: object
      required: [verificationToken, code]
      properties:
        verificationToken: { type: string }
        code: { type: string, example: "123456" }

    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email: { type: string, format: email, example: "marie.curie@example.com" }
        password: { type: string, format: password, example: "Password@123" }

    AuthTokens:
      type: object
      properties:
        accessToken: { type: string }
        refreshToken: { type: string }

    RefreshTokenRequest:
      type: object
      required: [refreshToken]
      properties:
        refreshToken: { type: string }

    ForgotPasswordRequest:
      type: object
      required: [email]
      properties:
        email: { type: string, format: email, example: "marie.curie@example.com" }

    ResetPasswordRequest:
      type: object
      required: [password]
      properties:
        password: { type: string, format: password, example: "NewPassword@123" }

    UpdateMeRequest:
      type: object
      properties:
        firstName: { type: string, example: "Maria" }
        lastName: { type: string, example: "Sk≈Çodowska" }

    UpdatePasswordRequest:
      type: object
      required: [currentPassword, newPassword]
      properties:
        currentPassword: { type: string, format: password }
        newPassword: { type: string, format: password }

    User:
      type: object
      properties:
        _id: { type: string, example: "a1b2c3d4-e5f6-..." }
        firstName: { type: string, example: "Marie" }
        lastName: { type: string, example: "Curie" }
        email: { type: string, example: "marie.curie@example.com" }
        roles: { type: array, items: { type: string, example: "user" } }

    ApiKey:
      type: object
      properties:
        id: { type: string, example: "key-uuid-123" }
        name: { type: string, example: "Mon App Mobile" }
        prefix: { type: string, example: "sk_12345" }
        permissions: { type: array, items: { type: string } }
        isActive: { type: boolean, example: true }
        usageCount: { type: number, example: 1250 }
        lastUsed: { type: string, format: date-time }
        expiresAt: { type: string, format: date-time }

    Role:
      type: object
      properties:
        id: { type: string }
        name: { type: string, example: "admin" }
        description: { type: string }
        permissions: { type: array, items: { type: string } }

    Permission:
      type: object
      properties:
        id: { type: string }
        action: { type: string, example: "read" }
        subject: { type: string, example: "user" }
        description: { type: string }

    Service:
      type: object
      properties:
        id: { type: string, example: "soristore" }
        name: { type: string, example: "SoriStore" }
        description: { type: string, example: "Marketplace e-commerce" }
        url: { type: string, example: "http://localhost:3001" }
        icon: { type: string, example: "üõçÔ∏è" }
        color: { type: string, example: "#3b82f6" }
        status: { type: string, enum: ["active", "inactive", "maintenance"], example: "active" }
        version: { type: string, example: "1.0.0" }
        endpoints: { type: array, items: { type: string } }
        responseTime: { type: number, example: 150 }
        uptime: { type: number, example: 99.9 }
        requestCount: { type: number, example: 1250 }
        errorCount: { type: number, example: 5 }
        ssoEnabled: { type: boolean, example: true }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }

    UserComplete:
      type: object
      properties:
        _id: { type: string, example: "a1b2c3d4-e5f6-..." }
        firstName: { type: string, example: "Marie" }
        lastName: { type: string, example: "Curie" }
        email: { type: string, example: "marie.curie@example.com" }
        isVerified: { type: boolean, example: true }
        isActive: { type: boolean, example: true }
        roles: { type: array, items: { type: string, example: "user" } }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }

    ApiKeyComplete:
      type: object
      properties:
        _id: { type: string, example: "key-uuid-123" }
        userId: { type: string, example: "user-uuid-456" }
        name: { type: string, example: "Mon App Mobile" }
        prefix: { type: string, example: "sk_12345" }
        permissions: { type: array, items: { type: string } }
        isActive: { type: boolean, example: true }
        lastUsed: { type: string, format: date-time }
        expiresAt: { type: string, format: date-time }
        rateLimit:
          type: object
          properties:
            requests: { type: number, example: 1000 }
            windowMs: { type: number, example: 3600000 }
        allowedIPs: { type: array, items: { type: string } }
        allowedDomains: { type: array, items: { type: string } }
        usageCount: { type: number, example: 1250 }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }

    RefreshToken:
      type: object
      properties:
        _id: { type: string }
        userId: { type: string }
        token: { type: string }
        expiresAt: { type: string, format: date-time }
        isRevoked: { type: boolean, example: false }
        createdAt: { type: string, format: date-time }

    SSOSession:
      type: object
      properties:
        _id: { type: string }
        userId: { type: string }
        serviceId: { type: string }
        sessionToken: { type: string }
        expiresAt: { type: string, format: date-time }
        isActive: { type: boolean, example: true }
        createdAt: { type: string, format: date-time }

    ServiceRequest:
      type: object
      properties:
        _id: { type: string }
        serviceId: { type: string }
        userId: { type: string }
        method: { type: string, example: "GET" }
        endpoint: { type: string, example: "/api/products" }
        statusCode: { type: number, example: 200 }
        responseTime: { type: number, example: 150 }
        timestamp: { type: string, format: date-time }
        userAgent: { type: string }
        ipAddress: { type: string }

    SimpleApiKey:
      type: object
      properties:
        _id: { type: string }
        name: { type: string, example: "Admin Key" }
        key: { type: string, example: "sk_admin_..." }
        permissions: { type: array, items: { type: string } }
        isActive: { type: boolean, example: true }
        createdAt: { type: string, format: date-time }

paths:
  # === AUTHENTIFICATION ===
  /auth/register:
    post:
      tags: [Authentification]
      summary: √âtape 1 - Demander la cr√©ation d'un compte
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignupRequest'
      responses:
        '200':
          description: Email de v√©rification envoy√©
        '400':
          description: Donn√©es invalides
        '409':
          description: Email d√©j√† utilis√©

  /auth/verify:
    post:
      tags: [Authentification]
      summary: √âtape 2 - V√©rifier le code et cr√©er le compte
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VerifyAccountRequest'
      responses:
        '201':
          description: Compte cr√©√© avec succ√®s
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthTokens'

  /auth/login:
    post:
      tags: [Authentification]
      summary: Connexion d'un utilisateur
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Connexion r√©ussie
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthTokens'

  /auth/refresh-token:
    post:
      tags: [Authentification]
      summary: Obtenir un nouvel access token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshTokenRequest'
      responses:
        '200':
          description: Nouveaux tokens g√©n√©r√©s
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthTokens'

  /auth/forgot-password:
    post:
      tags: [Authentification]
      summary: Demander une r√©initialisation de mot de passe
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ForgotPasswordRequest'
      responses:
        '200':
          description: Email de r√©initialisation envoy√©

  /auth/reset-password/{token}:
    post:
      tags: [Authentification]
      summary: R√©initialiser le mot de passe avec un token
      parameters:
        - in: path
          name: token
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResetPasswordRequest'
      responses:
        '200':
          description: Mot de passe r√©initialis√©

  # === GESTION DE COMPTE ===
  /auth/logout:
    post:
      tags: [Gestion de Compte]
      summary: D√©connexion de l'utilisateur
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshTokenRequest'
      responses:
        '200':
          description: D√©connexion r√©ussie

  /auth/me:
    get:
      tags: [Gestion de Compte]
      summary: R√©cup√©rer le profil de l'utilisateur connect√©
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Profil de l'utilisateur
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  /auth/update-me:
    patch:
      tags: [Gestion de Compte]
      summary: Mettre √† jour le profil utilisateur
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateMeRequest'
      responses:
        '200':
          description: Profil mis √† jour
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  /auth/update-password:
    patch:
      tags: [Gestion de Compte]
      summary: Mettre √† jour le mot de passe
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdatePasswordRequest'
      responses:
        '200':
          description: Mot de passe mis √† jour

  # === API KEYS ===
  /api/keys:
    get:
      tags: [API Keys]
      summary: Lister toutes les cl√©s API
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Liste des cl√©s API
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ApiKey'
    post:
      tags: [API Keys]
      summary: Cr√©er une nouvelle cl√© API
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name: { type: string, example: "Mon App" }
                permissions: { type: array, items: { type: string } }
      responses:
        '201':
          description: Cl√© API cr√©√©e

  /api/keys/{keyId}:
    get:
      tags: [API Keys]
      summary: D√©tails d'une cl√© API
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: keyId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: D√©tails de la cl√©
    delete:
      tags: [API Keys]
      summary: Supprimer une cl√© API
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: keyId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Cl√© supprim√©e

  # === SYST√àME ===
  /system/health:
    get:
      tags: [Syst√®me]
      summary: V√©rification de sant√© du syst√®me
      security:
        - ApiKeyAuth: []
        - bearerAuth: []
      responses:
        '200':
          description: Syst√®me op√©rationnel
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  data:
                    type: object
                    properties:
                      status: { type: string, example: "healthy" }
                      timestamp: { type: string, format: date-time }

  /system/roles:
    get:
      tags: [Syst√®me]
      summary: Lister tous les r√¥les
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Liste des r√¥les
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Role'

  /system/permissions:
    get:
      tags: [Syst√®me]
      summary: Lister toutes les permissions
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Liste des permissions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Permission'

  /system/services:
    get:
      tags: [Syst√®me]
      summary: Lister tous les services
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Liste des services
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Service'
    post:
      tags: [Syst√®me]
      summary: Cr√©er un nouveau service
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name: { type: string }
                description: { type: string }
                url: { type: string }
                icon: { type: string }
                color: { type: string }
      responses:
        '201':
          description: Service cr√©√©

  /system/services/{serviceId}:
    get:
      tags: [Syst√®me]
      summary: D√©tails d'un service
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: serviceId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: D√©tails du service
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Service'
    put:
      tags: [Syst√®me]
      summary: Mettre √† jour un service
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: serviceId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Service'
      responses:
        '200':
          description: Service mis √† jour
    delete:
      tags: [Syst√®me]
      summary: Supprimer un service
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: serviceId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Service supprim√©

  # === SSO ===
  /sso/login:
    post:
      tags: [SSO]
      summary: Connexion SSO
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                service: { type: string, example: "soristore" }
                redirectUrl: { type: string }
      responses:
        '200':
          description: Redirection SSO

  /sso/callback:
    get:
      tags: [SSO]
      summary: Callback SSO
      parameters:
        - in: query
          name: token
          schema:
            type: string
        - in: query
          name: service
          schema:
            type: string
      responses:
        '200':
          description: Authentification SSO r√©ussie

  # === ADMINISTRATION ===
  /admin/users:
    get:
      tags: [Administration]
      summary: Lister tous les utilisateurs
      security:
        - ApiKeyAuth: []
      responses:
        '200':
          description: Liste des utilisateurs
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/UserComplete'

  /admin/users/{userId}:
    get:
      tags: [Administration]
      summary: D√©tails d'un utilisateur
      security:
        - ApiKeyAuth: []
      parameters:
        - in: path
          name: userId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: D√©tails de l'utilisateur
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserComplete'
    delete:
      tags: [Administration]
      summary: Supprimer un utilisateur
      security:
        - ApiKeyAuth: []
      parameters:
        - in: path
          name: userId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Utilisateur supprim√©

  /admin/api-keys:
    get:
      tags: [Administration]
      summary: Lister toutes les cl√©s API
      security:
        - ApiKeyAuth: []
      responses:
        '200':
          description: Liste des cl√©s API
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ApiKeyComplete'

  /admin/sessions:
    get:
      tags: [Administration]
      summary: Lister toutes les sessions SSO
      security:
        - ApiKeyAuth: []
      responses:
        '200':
          description: Liste des sessions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/SSOSession'

  /admin/analytics:
    get:
      tags: [Administration]
      summary: Statistiques d'utilisation
      security:
        - ApiKeyAuth: []
      responses:
        '200':
          description: Statistiques
          content:
            application/json:
              schema:
                type: object
                properties:
                  totalUsers: { type: number }
                  activeUsers: { type: number }
                  totalRequests: { type: number }
                  totalServices: { type: number }
                  uptime: { type: number }

  # === PROXY ROUTES ===
  /soristore/{path}:
    get:
      tags: [Proxy]
      summary: Proxy vers SoriStore
      security:
        - ApiKeyAuth: []
        - bearerAuth: []
      parameters:
        - in: path
          name: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: R√©ponse du service SoriStore

  /soripay/{path}:
    get:
      tags: [Proxy]
      summary: Proxy vers SoriPay
      security:
        - ApiKeyAuth: []
        - bearerAuth: []
      parameters:
        - in: path
          name: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: R√©ponse du service SoriPay

  /soriwallet/{path}:
    get:
      tags: [Proxy]
      summary: Proxy vers SoriWallet
      security:
        - ApiKeyAuth: []
        - bearerAuth: []
      parameters:
        - in: path
          name: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: R√©ponse du service SoriWallet

  /sorilearn/{path}:
    get:
      tags: [Proxy]
      summary: Proxy vers SoriLearn
      security:
        - ApiKeyAuth: []
        - bearerAuth: []
      parameters:
        - in: path
          name: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: R√©ponse du service SoriLearn

  /sorihealth/{path}:
    get:
      tags: [Proxy]
      summary: Proxy vers SoriHealth
      security:
        - ApiKeyAuth: []
        - bearerAuth: []
      parameters:
        - in: path
          name: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: R√©ponse du service SoriHealth

  /soriaccess/{path}:
    get:
      tags: [Proxy]
      summary: Proxy vers SoriAccess
      security:
        - ApiKeyAuth: []
        - bearerAuth: []
      parameters:
        - in: path
          name: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: R√©ponse du service SoriAccess

security:
  - ApiKeyAuth: []
  - bearerAuth: []